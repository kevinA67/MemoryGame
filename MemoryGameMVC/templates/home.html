{% extends 'base.html' %}
{% load static %}
{% block title %}Inicio{% endblock %}

{% block content %}
<style>
  /* Fondo SOLO del tablero con tu imagen 'backround' */
  #game-board {
    min-height: 520px;
    padding: 16px;
    border-radius: 16px;
    background:
      linear-gradient(rgba(0,0,0,.35), rgba(0,0,0,.35)),
      url("{% static 'images/backround.png' %}") center/cover no-repeat;
    border: 1px solid rgba(255,255,255,.08);
  }

  /* Cartas correctas en VERDE + animaci√≥n */
  .card.matched {
    background-color: #198754 !important;
    transform: scale(1.03);
    box-shadow: 0 0 12px rgba(25,135,84,.6);
    pointer-events: none;
    animation: pop 240ms ease-out;
  }
  @keyframes pop {
    0% { transform: scale(1); }
    60% { transform: scale(1.08); }
    100% { transform: scale(1.03); }
  }
  .card.matched img { visibility: visible !important; }

  /* Progreso fino */
  .progress { height: 8px; }
</style>

<div class="container mt-4">
  <h1 class="mb-3">Juego de Memoria</h1>

  <div class="d-flex align-items-center flex-wrap gap-3 mb-3">
    <div class="d-flex align-items-center gap-2">
      <label class="form-label m-0" for="level">Nivel:</label>
      <select id="level" class="form-select form-select-sm w-auto">
        <option value="1">B√°sico (6 intentos, 60s)</option>
        <option value="2">Medio (4 intentos, 50s)</option>
        <option value="3">Avanzado (2 intentos, 40s)</option>
      </select>
    </div>

    <div class="d-flex align-items-center gap-3">
      <div>‚è±Ô∏è Tiempo: <span id="time">0</span>s</div>
      <div class="flex-grow-1" style="min-width: 220px;">
        <div class="progress">
          <div id="time-progress" class="progress-bar bg-success" role="progressbar" style="width: 100%;"></div>
        </div>
      </div>
    </div>

    <div class="ms-auto d-flex gap-2">
      <div class="btn btn-outline-secondary btn-sm disabled">‚≠ê <span id="score">0</span></div>
      <div class="btn btn-outline-secondary btn-sm disabled">üéØ <span id="attempts">0</span></div>
      <button id="startBtn" class="btn btn-primary btn-sm" onclick="startGame()">Iniciar</button>
      <button id="pauseBtn" class="btn btn-warning btn-sm" onclick="togglePause()" disabled>Pausar</button>
      <button id="muteBtn" class="btn btn-outline-light btn-sm">üîä Sonido</button>
    </div>
  </div>

  <div id="game-board"></div>
</div>

<!-- Modal de fin de partida -->
<div class="modal fade" id="endModal" tabindex="-1" aria-labelledby="endModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="endModalLabel">Resultado</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <p id="endModalText" class="mb-0">‚Äî</p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary" id="playAgainBtn">Volver a jugar</button>
      </div>
    </div>
  </div>
</div>

<!-- ==== Script al final ==== -->
<script>
  /************ CSRF para Django ************/
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  /************ Enviar resultado a Django (incluye nivel y segundos) ************/
  function guardarResultadoPartida(won) {
    const level = parseInt(document.getElementById('level').value || "1", 10);
    const secondsUsed = Math.max(0, initialTime - timeLeft); // tiempo jugado

    fetch("{% url 'save_result' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      body: `won=${won}&score=${encodeURIComponent(score)}&level=${level}&seconds=${secondsUsed}`,
    })
    .then(r => r.json())
    .then(d => console.log("Resultado guardado:", d))
    .catch(e => console.error("Error al guardar:", e));
  }

  // Sonidos
  const soundSelect = new Audio("{% static 'sounds/select.mp3' %}");
  const soundWin    = new Audio("{% static 'sounds/win.mp3' %}");
  const soundLose   = new Audio("{% static 'sounds/lose.mp3' %}");
  const backgroundMusic = new Audio("{% static 'sounds/background.mp3' %}");
  backgroundMusic.loop = true;
  backgroundMusic.volume = 0.3;
  let soundsMuted = false;

  // Im√°genes de frutas (8 pares = 16 cartas, tablero 4x4)
  const fruits = [
    "{% static 'images/manzana.png' %}",
    "{% static 'images/minimo.png' %}",
    "{% static 'images/cherry.png' %}",
    "{% static 'images/uva.png' %}",
    "{% static 'images/kiwi.png' %}",
    "{% static 'images/fresa.png' %}",
    "{% static 'images/pina.png' %}",
    "{% static 'images/sandia.png' %}"
  ];

  // Referencias
  const gameBoard  = document.getElementById('game-board');
  const timeDisplay  = document.getElementById('time');
  const scoreDisplay = document.getElementById('score');
  const levelSelect  = document.getElementById('level');
  const attemptsDisplay = document.getElementById('attempts');
  const pauseBtn = document.getElementById('pauseBtn');
  const muteBtn = document.getElementById('muteBtn');
  const endModalEl = document.getElementById('endModal');
  const endModalText = document.getElementById('endModalText');
  const playAgainBtn = document.getElementById('playAgainBtn');
  const timeBar = document.getElementById('time-progress');
  let endModal;

  // Estado
  let flippedCards = [];
  let matchedPairs = 0;
  let score = 0;
  let timeLeft = 0;
  let timer;
  const totalPairs = 8;     // SIEMPRE 8 pares (tablero 4x4)
  let attemptsLeft = 0;
  let gameOver = false;
  let initialTime = 0;    // tiempo inicial seg√∫n nivel
  let paused = false;

  // Modal bootstrap
  document.addEventListener('DOMContentLoaded', () => {
    endModal = new bootstrap.Modal(endModalEl);
    playAgainBtn.addEventListener('click', () => {
      endModal.hide();
      startGame();
    });
    muteBtn.addEventListener('click', toggleMute);
  });

  // Mezclar
  function shuffle(array) {
    for (let i = array.length -1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i+1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  // Intentos por nivel (B√°sico 6, Medio 4, Avanzado 2)
  function intentosPorNivel(level) {
    if (level === 1) return 6;
    if (level === 2) return 4;
    return 2;
  }

  // Tiempo por nivel (B√°sico 60s, Medio 50s, Avanzado 40s)
  function tiempoPorNivel(level) {
    if (level === 1) return 60;
    if (level === 2) return 50;
    return 40;
  }

  // ======= Timer helpers =======
  function startTimer() {
    clearInterval(timer);
    timer = setInterval(() => {
      timeLeft--;
      updateTimeUI();
      if (timeLeft <= 0) {
        endGame(false, "time");
      }
    }, 1000);
  }

  function pauseTimer() {
    clearInterval(timer);
  }

  function updateTimeUI() {
    timeDisplay.textContent = timeLeft;
    const pct = initialTime > 0 ? Math.max(0, Math.min(100, Math.round((timeLeft / initialTime) * 100))) : 0;
    timeBar.style.width = pct + '%';
    timeBar.classList.remove('bg-success','bg-warning','bg-danger');
    if (pct > 50) timeBar.classList.add('bg-success');
    else if (pct > 25) timeBar.classList.add('bg-warning');
    else timeBar.classList.add('bg-danger');
  }

  // Finalizar juego (centralizado)
  function endGame(won, reason) {
    if (gameOver) return;
    gameOver = true;
    paused = false;
    pauseBtn.disabled = true;
    pauseBtn.textContent = "Pausar";
    pauseBtn.classList.remove("btn-success");
    pauseBtn.classList.add("btn-warning");

    clearInterval(timer);
    backgroundMusic.pause();
    try { (won ? soundWin : soundLose).play(); } catch {}

    const mensaje = won
      ? `¬°Ganaste! Puntuaci√≥n final: ${score}`
      : (reason === "attempts"
          ? `¬°Sin intentos! Puntuaci√≥n final: ${score}`
          : `Se acab√≥ el tiempo. Puntuaci√≥n final: ${score}`);

    // guardar y mostrar modal
    guardarResultadoPartida(won);
    gameBoard.innerHTML = '';
    endModalText.textContent = mensaje;
    endModal.show();
  }

  // Iniciar juego
  function startGame() {
    clearInterval(timer);
    gameOver = false;
    paused = false;
    pauseBtn.disabled = false;
    pauseBtn.textContent = "Pausar";
    pauseBtn.classList.remove("btn-success");
    pauseBtn.classList.add("btn-warning");

    score = 0;
    matchedPairs = 0;

    const level = parseInt(levelSelect.value);

    // Configurar TIEMPO seg√∫n nivel
    initialTime = tiempoPorNivel(level);
    timeLeft = initialTime;
    updateTimeUI();

    // Configurar INTENTOS seg√∫n nivel
    attemptsLeft = intentosPorNivel(level);
    attemptsDisplay.textContent = attemptsLeft;

    scoreDisplay.textContent = score;

    const selectedFruits = fruits.slice(0, totalPairs);
    const cards = shuffle([...selectedFruits, ...selectedFruits]);

    gameBoard.innerHTML = '';

    // Cuadr√≠cula FIJA 4x4
    const columns = 4;
    gameBoard.style.display = 'grid';
    gameBoard.style.gridTemplateColumns = `repeat(${columns}, 100px)`;
    gameBoard.style.justifyContent = 'center';
    gameBoard.style.gap = '10px';

    // Crear cartas
    cards.forEach(fruit => {
      const card = document.createElement('div');
      card.classList.add('card');
      card.dataset.fruit = fruit;

      const img = document.createElement('img');
      img.src = fruit;
      img.style.width = '50px';
      img.style.height = '50px';
      img.style.visibility = 'hidden';

      card.appendChild(img);
      card.style.cssText = `
        width: 100px;
        height: 100px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #4e73df;
        border-radius: 8px;
        cursor: pointer;
        user-select: none;
        transition: transform .2s;
      `;
      card.addEventListener('click', () => flipCard(card));
      gameBoard.appendChild(card);
    });

    // M√∫sica
    if (!soundsMuted) backgroundMusic.play().catch(() => {});

    // Temporizador (p√©rdida por tiempo)
    startTimer();
  }

  // Pausar/Reanudar
  function togglePause() {
    if (gameOver) return;
    if (!paused) {
      // Pausar
      paused = true;
      pauseTimer();
      try { backgroundMusic.pause(); } catch {}
      pauseBtn.textContent = "Reanudar";
      pauseBtn.classList.remove("btn-warning");
      pauseBtn.classList.add("btn-success");
    } else {
      // Reanudar
      paused = false;
      startTimer();
      if (!soundsMuted) backgroundMusic.play().catch(() => {});
      pauseBtn.textContent = "Pausar";
      pauseBtn.classList.remove("btn-success");
      pauseBtn.classList.add("btn-warning");
    }
  }

  // Mute/Unmute
  function toggleMute() {
    soundsMuted = !soundsMuted;
    const all = [soundSelect, soundWin, soundLose, backgroundMusic];
    all.forEach(a => a.muted = soundsMuted);
    muteBtn.textContent = soundsMuted ? "üîá Silencio" : "üîä Sonido";
    if (soundsMuted) backgroundMusic.pause(); else if (!paused && !gameOver) backgroundMusic.play().catch(() => {});
  }

  // Voltear carta
  function flipCard(card) {
    if (gameOver || paused) return;
    if (flippedCards.length >= 2 || flippedCards.includes(card) || card.classList.contains('matched')) return;

    try { if (!soundsMuted) { soundSelect.currentTime = 0; soundSelect.play(); } } catch {}

    const img = card.querySelector('img');
    img.style.visibility = 'visible';
    card.style.transform = 'scale(1.03)';

    flippedCards.push(card);

    if (flippedCards.length === 2) {
      setTimeout(checkMatch, 400);
    }
  }

  // Comparar cartas (intentos bajan solo cuando FALLAS)
  function checkMatch() {
    const [card1, card2] = flippedCards;
    const img1 = card1.querySelector('img');
    const img2 = card2.querySelector('img');

    if (card1.dataset.fruit === card2.dataset.fruit) {
      card1.classList.add('matched');
      card2.classList.add('matched');
      score += 10;
      matchedPairs++;
      scoreDisplay.textContent = score;

      if (matchedPairs === totalPairs) {
        endGame(true);
      }
    } else {
      // Fallo => consumimos 1 intento
      attemptsLeft = Math.max(0, attemptsLeft - 1);
      attemptsDisplay.textContent = attemptsLeft;

      setTimeout(() => {
        img1.style.visibility = 'hidden';
        img2.style.visibility = 'hidden';
        if (attemptsLeft === 0) {
          endGame(false, "attempts");
        }
      }, 700);
    }
    flippedCards = [];
  }
</script>
{% endblock %}
